<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Setup - Russian Roulette</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .prob-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        .prob-display .total {
            font-size: 1.5em;
            font-weight: bold;
        }
        .prob-display .valid {
            color: #4ade80;
        }
        .prob-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .prob-item {
            text-align: center;
        }
        .prob-item .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .prob-item .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .advantage-indicator {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .house-advantage {
            background: #fecaca;
            color: #991b1b;
        }
        .player-advantage {
            background: #bbf7d0;
            color: #166534;
        }
        .fair-game {
            background: #e0e7ff;
            color: #3730a3;
        }
    </style>
</head>
<body>
    <div class="container setup-container">
        <h1>üéÆ Game Setup</h1>

        <form id="setupForm">
            <!-- Game Mode (hidden, passed from index) -->
            <input type="hidden" id="mode" name="mode">

            <!-- Player Names -->
            <div class="form-group">
                <label for="player1">Player 1 Name (Boy üë¶):</label>
                <input type="text" id="player1" name="player1_name" placeholder="Enter name"  required>
            </div>

            <div class="form-group" id="player2Group">
                <label for="player2">Player 2 Name (Girl üëß):</label>
                <input type="text" id="player2" name="player2_name" placeholder="Enter name"  required>
            </div>

            <!-- Casino Mode Options (shown only for Mode 4) -->
            <div id="casinoOptions" style="display: none;">
                <h3>üí∞ Casino Mode Settings</h3>
                <div class="form-group">
                    <label for="startingBalance">Starting Balance (‚Ç±):</label>
                    <input type="number" id="startingBalance" name="starting_balance" min="100" max="1000000" value="1000">
                </div>
                <div class="form-group">
                    <label for="initialBet">Initial Bet (‚Ç±):</label>
                    <input type="number" id="initialBet" name="initial_bet" min="10" max="10000" value="100">
                    <small>Win = 2x Bet | Lose = Lose Bet</small>
                </div>
            </div>

            <!-- Basic Game Settings -->
            <h3>Game Settings</h3>

            <div class="form-group">
                <label for="chambers">Number of Chambers (3-12):</label>
                <input type="number" id="chambers" name="chambers" min="3" max="12" value="6" required>
            </div>

            <div class="form-group">
                <label for="bullets">Number of Bullets (1-5):</label>
                <input type="number" id="bullets" name="bullets" min="1" max="5" value="1" required>
            </div>

            <!-- Tweaked Game Options (shown only for Mode 3 or 4) -->
            <div id="tweakedOptions" style="display: none;">
                <h3>üéØ Probability Settings</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Set the probability that the bullet is placed in an <strong>EVEN</strong> chamber (Computer's turns).
                    The <strong>ODD</strong> probability (Player's turns) is automatically calculated to ensure they sum to 100%.
                </p>

                <div class="form-group">
                    <label for="evenProb">Bullet in EVEN Chamber (Computer's turns):</label>
                    <input type="range" id="evenProb" name="even_prob" min="0" max="100" value="35" step="1" oninput="updateProbDisplay()">
                    <div class="prob-display">
                        <div class="prob-breakdown">
                            <div class="prob-item">
                                <div class="value" id="evenProbValue">35%</div>
                                <div class="label">Even (Computer)</div>
                            </div>
                            <div class="prob-item">
                                <div class="value">+</div>
                                <div class="label">&nbsp;</div>
                            </div>
                            <div class="prob-item">
                                <div class="value" id="oddProbValue">65%</div>
                                <div class="label">Odd (Player)</div>
                            </div>
                            <div class="prob-item">
                                <div class="value">=</div>
                                <div class="label">&nbsp;</div>
                            </div>
                            <div class="prob-item">
                                <div class="value total valid">100%</div>
                                <div class="label">Total ‚úì</div>
                            </div>
                        </div>
                        <div id="advantageIndicator" class="advantage-indicator house-advantage">
                            üè† House Advantage: Player more likely to get shot
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="useFairGame" onchange="toggleFairGame()">
                        Use Fair Game (50/50 distribution)
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-success" id="submitBtn">Start Game</button>
            <a href="/" class="btn btn-secondary">Back</a>
        </form>
    </div>

    <script>
        const mode = sessionStorage.getItem('gameMode') || '2';
        document.getElementById('mode').value = mode;

        // Show tweaked options for mode 3 or 4, casino options for mode 4
        if (mode === '3' || mode === '4') {
            document.getElementById('tweakedOptions').style.display = 'block';
        }
        if (mode === '4') {
            document.getElementById('casinoOptions').style.display = 'block';
            document.getElementById('player2Group').style.display = 'none';
            document.getElementById('player2').value = 'Computer ü§ñ';
            document.getElementById('player2').required = false;
        }

        function updateProbDisplay() {
            const evenProb = parseInt(document.getElementById('evenProb').value);
            const oddProb = 100 - evenProb;
            
            document.getElementById('evenProbValue').textContent = evenProb + '%';
            document.getElementById('oddProbValue').textContent = oddProb + '%';
            
            const indicator = document.getElementById('advantageIndicator');
            if (evenProb < 50) {
                indicator.className = 'advantage-indicator house-advantage';
                indicator.innerHTML = 'üè† House Advantage: Player (' + oddProb + '%) more likely to get shot';
            } else if (evenProb > 50) {
                indicator.className = 'advantage-indicator player-advantage';
                indicator.innerHTML = 'üéâ Player Advantage: Computer (' + evenProb + '%) more likely to get shot';
            } else {
                indicator.className = 'advantage-indicator fair-game';
                indicator.innerHTML = '‚öñÔ∏è Fair Game: Equal 50/50 chance';
            }
        }

        function toggleFairGame() {
            const isFair = document.getElementById('useFairGame').checked;
            const slider = document.getElementById('evenProb');
            
            if (isFair) {
                slider.value = 50;
                slider.disabled = true;
            } else {
                slider.disabled = false;
            }
            updateProbDisplay();
        }

        // Initial display update
        updateProbDisplay();

        // Form submission
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const useFairGame = document.getElementById('useFairGame')?.checked || false;
            const evenProb = useFairGame ? null : parseInt(document.getElementById('evenProb').value);
            
            const data = {
                mode: document.getElementById('mode').value,
                player1_name: document.getElementById('player1').value,
                player2_name: document.getElementById('player2').value,
                chambers: document.getElementById('chambers').value,
                bullets: document.getElementById('bullets').value,
            };

            // Add tweaked options if mode 3 or 4
            if (mode === '3' || mode === '4') {
                if (!useFairGame && evenProb !== null) {
                    data.even_prob = evenProb;  // Send as 0-100, server will divide by 100
                }
            }

            // Add casino mode options if mode 4
            if (mode === '4') {
                data.starting_balance = parseInt(document.getElementById('startingBalance').value);
                data.initial_bet = parseInt(document.getElementById('initialBet').value);
                data.player2_name = 'Computer ü§ñ';
            }

            try {
                const response = await fetch('/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    window.location.href = result.redirect;
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error setting up game: ' + error);
            }
        });
    </script>
</body>
</html>